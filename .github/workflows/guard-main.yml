name: Guard Main (docs-only, author-aware)

on:
  pull_request:
    branches: [ main ]

jobs:
  check-paths:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      docs_only: ${{ steps.check.outputs.docs_only }}
      pattern_ok: ${{ steps.check.outputs.pattern_ok }}

    steps:
      - name: Validate changed files via GitHub API
        id: check
        uses: actions/github-script@v7
        with:
          script: |

            const pr = context.payload.pull_request;
            const author = pr.user.login;
            core.info(`PR author: ${author}`);

            const ALLOWED_AUTHORS = ["zhang22391", "hashizume21474"];

            // 主催者なら制限なしでOK
            if (ALLOWED_AUTHORS.includes(author)) {
              core.info("Author is in ALLOWED_AUTHORS. Skipping docs-only restriction.");
              core.setOutput("docs_only", "true");
              core.setOutput("pattern_ok", "true");
              return;
            }

            const { owner, repo } = context.repo;

            // PR に含まれるファイル一覧を取得
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              { owner, repo, pull_number: pr.number, per_page: 100 }
            );

            core.info("Changed files:");
            files.forEach(f => core.info(`- ${f.filename}`));

            let docsOnly = true;
            let patternOk = true;

            // 命名規則: docs/.../teamX_第NN回.md
            // 例: docs/01-GitHubActionsの基礎(第2回)/teamA_第01回.md
            const nameRegex = /^docs\/.+\/team[A-Za-z0-9]+_第[0-9]{2}回\.md$/u;

            for (const f of files) {
              const path = f.filename;

              // 1) docs/ 配下かつ .md か？
              if (!path.startsWith("docs/") || !path.endsWith(".md")) {
                docsOnly = false;
              }

              // 2) ファイル名パターンチェック
              if (!nameRegex.test(path)) {
                patternOk = false;
              }
            }

            core.setOutput("docs_only", docsOnly ? "true" : "false");
            core.setOutput("pattern_ok", patternOk ? "true" : "false");

            if (!docsOnly) {
              core.setFailed("❌ docs/配下の .md 以外の変更が含まれています（主催者以外には禁止）。");
            } else {
              core.info("✅ 一般参加者による変更は docs/** 内の .md のみに収まっています。");
            }