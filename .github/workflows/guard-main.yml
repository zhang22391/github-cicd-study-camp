name: Guard Main (docs & teams only, author-aware)

on:
  pull_request_target:
    branches: [ main ]

jobs:
  check-paths:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      docs_only: ${{ steps.check.outputs.docs_only }}
      pattern_ok: ${{ steps.check.outputs.pattern_ok }}

    steps:
      - name: Validate changed files via GitHub API
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const author = pr.user.login;
            core.info(`PR author: ${author}`);

            // ğŸ‘‡ ä¸»å‚¬è€…ï¼ˆåˆ¶é™ãªã—ã§OKï¼‰ã‚’ã“ã“ã«åˆ—æŒ™
            const ALLOWED_AUTHORS = ["jyzhang9812","hashizume21474"];

            // ä¸»å‚¬è€…ãªã‚‰åˆ¶é™ãªã—
            if (ALLOWED_AUTHORS.includes(author)) {
              core.info("Author is in ALLOWED_AUTHORS. Skipping path restriction.");
              core.setOutput("docs_only", "true");
              core.setOutput("pattern_ok", "true");
              return;
            }

            const { owner, repo } = context.repo;

            // PR ã«å«ã¾ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              { owner, repo, pull_number: pr.number, per_page: 100 }
            );

            core.info("Changed files:");
            files.forEach(f => core.info(`- ${f.filename}`));

            let docsOnly = true;    // å¤‰æ›´ãŒ docs/** ã®ã¿ã‹ã©ã†ã‹
            let patternOk = true;   // docs/** é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«åãŒãƒ«ãƒ¼ãƒ«ã«æ²¿ã£ã¦ã„ã‚‹ã‹
            let allPathsAllowed = true; // docs/** or teams/** ä»¥å¤–ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹

            // ãƒ¡ãƒ¢ã®å‘½åè¦å‰‡:
            // ä¾‹: docs/ç¬¬01å›_ç¬¬2ç« _Actionsã®åŸºæœ¬/team-a.md
            // - ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹: docs/
            // - ä¸­é–“ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ä»»æ„
            // - ãƒ•ã‚¡ã‚¤ãƒ«å: team-è‹±æ•°å­—.md
            const memoNameRegex = /^docs\/.+\/team-[A-Za-z0-9-]+\.md$/u;

            for (const f of files) {
              const path = f.filename;

              // 1) è¨±å¯ãƒ‘ã‚¹åˆ¤å®š: docs/** ã¾ãŸã¯ teams/** ã®ã¿è¨±å¯
              if (!(path.startsWith("docs/") || path.startsWith("teams/"))) {
                allPathsAllowed = false;
              }

              // 2) docs_only åˆ¤å®šï¼ˆ1ã¤ã§ã‚‚ docs/ ä»¥å¤–ãŒã‚ã‚Œã° falseï¼‰
              if (!path.startsWith("docs/")) {
                docsOnly = false;
              }

              // 3) docs/** é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«åãƒ«ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
              if (path.startsWith("docs/")) {
                if (!memoNameRegex.test(path)) {
                  patternOk = false;
                }
              }
            }

            // å‡ºåŠ›ï¼ˆauto-merge ç­‰ã§åˆ©ç”¨ã™ã‚‹æƒ³å®šï¼‰
            core.setOutput("docs_only", docsOnly ? "true" : "false");
            core.setOutput("pattern_ok", patternOk ? "true" : "false");

            // ãƒ‘ã‚¹åˆ¶é™ã«é•åã—ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
            if (!allPathsAllowed) {
              core.setFailed(
                "âŒ docs/** ã¾ãŸã¯ teams/** ä»¥å¤–ã®ãƒ‘ã‚¹ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼ˆä¸€èˆ¬å‚åŠ è€…ã«ã¯ç¦æ­¢ï¼‰ã€‚\n" +
                "âœ… ä¸€èˆ¬å‚åŠ è€…ãŒ main ã«å«ã‚ã¦ã‚ˆã„ã®ã¯ docs/** ã¨ teams/** ã®ã¿ã§ã™ã€‚"
              );
              return;
            }

            core.info("âœ… ä¸€èˆ¬å‚åŠ è€…ã«ã‚ˆã‚‹å¤‰æ›´ã¯ docs/** ã¨ teams/** ã®ã¿ã«åã¾ã£ã¦ã„ã¾ã™ã€‚");
            if (docsOnly) {
              core.info("âœ… å¤‰æ›´ã¯ docs/** ã®ã¿ã§ã™ï¼ˆdocs_only = trueï¼‰");
            } else {
              core.info("â„¹ï¸ docs/** ä»¥å¤–ã« teams/** ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™ï¼ˆdocs_only = falseï¼‰");
            }
            if (!patternOk) {
              core.info("â„¹ï¸ docs/** é…ä¸‹ã«å‘½åè¦å‰‡ã«åˆã‚ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã™ï¼ˆauto-merge å¯¾è±¡å¤–ï¼‰ã€‚");
            }